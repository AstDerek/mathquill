/**
 * Copyright 2010 Jay and Han (laughinghan@gmail.com)
 * License, Usage and Readme at http://mathquill.com
 */(function(a){function Q(a,b,c){i.apply(this,arguments)}function P(b){this.parent=this.root=b;var c=this.jQ=this._jQ=a('<span class="cursor"></span>');this.blink=function(){c.toggleClass("blink")}}function O(a,b){g.call(this,"\\"+b+" ","<span>"+b+"</span>")}function N(a,b){g.call(this,a,"<big>"+b+"</big>")}function M(a,b){J.apply(this,arguments)}function L(a,b,c){g.call(this,a,'<span class="binary-operator">'+b+"</span>",c)}function K(a,b){g.call(this,a,'<span class="nonSymbola">'+(b||a)+"</span>")}function J(a,b){g.call(this,a,"<span>"+(b||a)+"</span>")}function I(a,b){g.call(this,a,"<var>"+(b||a)+"</var>")}function H(a){var b=Array.prototype.slice.call(arguments,1);return q(a,function(){a.apply(this,b)})}function G(a){f.call(this,"\\vector",c,c,a)}function F(){E.apply(this,arguments)}function E(a){f.call(this,"\\binom",c,c,a),this.jQ.wrapInner('<span class="array"></span>').prepend('<span class="paren">(</span>').append('<span class="paren">)</span>')}function D(a){f.call(this,"\\"),a&&(this.replacedFragment=a.detach(),this.isEmpty=function(){return!1})}function C(){}function B(a){a instanceof i?this.replacedText=a.remove().jQ.text():typeof a=="string"&&(this.replacedText=a),f.call(this,"\\text")}function A(a){y.call(this,"|","|",a)}function z(a,b,c){x.call(this,a,b,a,b,c)}function y(a,b,c){w.call(this,a,b,a,b,c)}function x(a,b,c,d,e){w.apply(this,arguments)}function w(a,b,c,d,e){f.call(this,c,['<span><span class="paren">'+a+'</span><span></span><span class="paren">'+b+"</span></span>"],[a,b],e),this.end=d}function v(a){u.call(this,a),this.jQ=this.firstChild.jQ.detach().add(this.jQ)}function u(a){f.call(this,"\\sqrt",c,c,a)}function t(){s.apply(this,arguments)}function s(a){f.call(this,"\\frac",c,c,a),this.jQ.append('<span style="width:0">&nbsp;</span>')}function r(a,b,c,d){f.call(this,a,[b],[c],d)}function q(a,b){b.prototype=a.prototype;return b}function n(){}function m(a){f.call(this,"$"),this.firstChild.cursor=a,this.firstChild.textInput=function(b){this.skipTextInput||(b!=="$"||a.parent!==this?a.write(b):this.isEmpty()?a.insertAfter(this.parent).backspace().insertNew(new J("\\$","$")).show():a.next?a.prev?a.write(b):a.insertBefore(this.parent):a.insertAfter(this.parent))}}function l(){}function k(b,d){var e=[{name:"Basic",example:"+",button_groups:[["subscript","supscript","frac","sqrt","nthroot","langle","binomial","vector","f","prime"],["+","-","pm","mp","cdot","=","times","div","ast"],["therefore","because"],["sum","prod","coprod","int"],["N","P","Z","Q","R","C","H"]]},{name:"Greek",example:"&pi;",button_groups:[["alpha","beta","gamma","delta","epsilon","zeta","eta","theta","iota","kappa","lambda","mu","nu","xi","pi","rho","sigma","tau","upsilon","phi","chi","psi","omega"],["digamma","varepsilon","vartheta","varkappa","varpi","varrho","varsigma","varphi"],["Gamma","Delta","Theta","Lambda","Xi","Pi","Sigma","Upsilon","Phi","Psi","Omega"]]},{name:"Operators",example:"&oplus;",button_groups:[["wedge","vee","cup","cap","diamond","bigtriangleup","ominus","uplus","otimes","oplus","bigtriangledown","sqcap","triangleleft","sqcup","triangleright","odot","bigcirc","dagger","ddagger","wr","amalg"]]},{name:"Relationships",example:"&le;",button_groups:[["<",">","equiv","cong","sim","notin","ne","propto","approx","le","ge","in","ni","notni","subset","supset","notsubset","notsupset","subseteq","supseteq","notsubseteq","notsupseteq","models","prec","succ","preceq","succeq","simeq","mid","ll","gg","parallel","bowtie","sqsubset","sqsupset","smile","sqsubseteq","sqsupseteq","doteq","frown","vdash","dashv","exists","varnothing"]]},{name:"Arrows",example:"&hArr;",button_groups:[["longleftarrow","longrightarrow","Longleftarrow","Longrightarrow","longleftrightarrow","updownarrow","Longleftrightarrow","Updownarrow","mapsto","nearrow","hookleftarrow","hookrightarrow","searrow","leftharpoonup","rightharpoonup","swarrow","leftharpoondown","rightharpoondown","nwarrow","downarrow","Downarrow","uparrow","Uparrow","rightarrow","Rightarrow","leftarrow","lArr","leftrightarrow","Leftrightarrow"]]},{name:"Delimiters",example:"{",button_groups:[["lfloor","rfloor","lceil","rceil","slash","opencurlybrace","closecurlybrace"]]},{name:"Misc",example:"&infin;",button_groups:[["forall","ldots","cdots","vdots","ddots","surd","triangle","ell","top","flat","natural","sharp","wp","bot","clubsuit","diamondsuit","heartsuit","spadesuit","caret","underscore","backslash","vert","perp","nabla","hbar","AA","circ","bullet","setminus","neg","dots","Re","Im","partial","infty","aleph","deg","angle"]]}],f={binomial:'<span style="font-size: 0.5em"><span class="paren" style="font-size: 2.087912087912088em; ">(</span><span class="array"><span><var>n</var></span><span><var>m</var></span></span><span class="paren" style="font-size: 2.087912087912088em; ">)</span></span>',frac:'<span style="font-size: 0.55em" class="fraction"><span class="numerator"><var>n</var></span><span class="denominator"><var>m</var></span><span style="width:0"></span></span>',sqrt:'<span style="font-size: 0.8em; padding-top: 3px"><span class="sqrt-prefix">&radic;</span><span class="sqrt-stem" style="border-top-width: 1.7142857142857144px;">&nbsp;</span></span>',nthroot:'<span style="font-size: 0.7em"><sup class="nthroot"><var>n</var></sup><span><span class="sqrt-prefix">&radic;</span><span class="sqrt-stem" style="border-top-width: 1.7142857142857144px; ">&nbsp;</span></span></span>',supscript:'<sup style="font-size: 0.6em">sup</sup>',subscript:'<sub style="font-size: 0.6em; line-height: 3.5;">sub</sub>',vector:'<span class="array" style="font-size: 0.6em"><span class=""><var>a</var><span> </span><var>b</var></span><span class=""><var>c</var><span> </span><var>d</var></span></span>'},g=[],h=[];a.each(e,function(b,d){g.push('<li><a href="#'+d.name+'_tab"><span class="mathquill-rendered-math">'+d.example+"</span>"+d.name+"</a></li>");var e=[];a.each(d.button_groups,function(b,d){a.each(d,function(a,b){var d=new p[b](c,b);e.push('<li><a class="mathquill-rendered-math" title="'+(b.match(/^[a-z]+$/)?"\\"+b:b)+'">'+(f[b]?f[b]:'<span style="line-height: 1.5em">'+d.html_template.join("")+"</span>")+"</a></li>")}),e.push('<li class="mathquill-button-spacer"></li>')}),h.push('<div class="mathquill-tab-pane" id="'+d.name+'_tab"><ul>'+e.join("")+"</ul></div>")}),b.toolbar=a('<div class="mathquill-toolbar"><ul class="mathquill-tab-bar">'+g.join("")+'</ul><div class="mathquill-toolbar-panes">'+h.join("")+"</div></div>").prependTo(d),d.find(".mathquill-tab-bar li a").mouseenter(function(){d.find(".mathquill-tab-bar li").removeClass("mathquill-tab-selected"),d.find(".mathquill-tab-pane").removeClass("mathquill-tab-pane-selected"),a(this).parent().addClass("mathquill-tab-selected"),a(this.href.replace(/.*#/,"#")).addClass("mathquill-tab-pane-selected")}),d.find(".mathquill-tab-bar li:first-child a").mouseenter(),d.find("a.mathquill-rendered-math").mousedown(function(a){a.stopPropagation()}).click(function(){b.cursor.writeLatex(this.title,!0),d.focus()})}function j(b,e,f,g,h){function q(d){r=c,j.blink=s,j.selection||j.show(),b.unbind("mousemove",o),a(document).unbind("mousemove",p).unbind("mouseup",q)}function p(a){delete a.target;return o(a)}function o(b){j.seek(a(b.target),b.pageX,b.pageY),j.prev===r.prev&&j.parent===r.parent?j.clearSelection():j.selectFrom(r);return!1}function m(){var a=l.val();!a||(l.val(""),j.parent.textInput(a))}var i=b.contents().detach();f||b.addClass("mathquill-rendered-math"),e.jQ=b.data(d,{block:e,revert:function(){b.empty().unbind(".mathquill").removeClass("mathquill-rendered-math mathquill-editable mathquill-textbox mathquill-editor").append(i)}});var j=e.cursor=new P(e);e.renderLatex(i.text());if(!!g){e.textarea=a('<span class="textarea"><textarea></textarea></span>').prependTo(b.addClass("mathquill-editable"));var l=e.textarea.children();f&&b.addClass("mathquill-textbox"),h&&k(e,b),l.focus(function(a){j.parent||j.appendTo(e),j.parent.jQ.addClass("hasCursor"),j.selection?j.selection.jQ.removeClass("blur"):j.show(),a.stopPropagation()}).blur(function(a){j.hide().parent.blur(),j.selection&&j.selection.jQ.addClass("blur"),a.stopPropagation()}).bind("selectstart",function(a){a.stopPropagation()});var n={};b.bind("focus.mathquill blur.mathquill",function(a){l.trigger(a)}).bind("keydown.mathquill",function(a){n.evt=a,n.happened=!0,n.returnValue=j.parent.keydown(a);if(n.returnValue)return!0;a.stopImmediatePropagation();return!1}).bind("keypress.mathquill",function(a){n.happened?n.happened=!1:n.returnValue=j.parent.keydown(n.evt);if(!n.returnValue)return!1;setTimeout(m)}).bind("mousedown.mathquill",function(c){j.seek(a(c.target),c.pageX,c.pageY).blink=a.noop,r=new P(e),r.jQ=r._jQ=a(),j.next?r.insertBefore(j.next):r.appendTo(j.parent),b.mousemove(o),a(document).mousemove(p).mouseup(q),setTimeout(function(){l.focus()})}).bind("selectstart.mathquill",!1).blur();var r,s=j.blink}}function i(b,c,d){if(!!arguments.length){var e=this;e.parent=b,e.prev=c||0,e.next=d||0,e.jQinit(e.fold(a(),function(a,b){return b.jQ.add(a)}))}}function h(){}function g(a,b,c){f.call(this,a,[b],[c||(a&&a.length>1?a.slice(1):a)])}function f(b,c,e,f){if(!!arguments.length){var g=this;g.cmd=b,c&&(g.html_template=c),e&&(g.text_template=e),g.jQ=a(g.html_template[0]).data(d,{cmd:g}),g.initBlocks(f)}}function e(){}var b,c,d="[[mathquill internal data]]";b=e.prototype,b.prev=0,b.next=0,b.parent=0,b.firstChild=0,b.lastChild=0,b.eachChild=function(a){for(var b=this.firstChild;b;b=b.next)if(a.call(this,b)===!1)break;return this},b.foldChildren=function(a,b){this.eachChild(function(c){a=b.call(this,a,c)});return a},b.keydown=function(a){return this.parent.keydown(a)},b.textInput=function(a){return this.parent.textInput(a)},b=f.prototype=new e,b.initBlocks=function(b){var c=this;if(c.html_template.length===1)c.firstChild=c.lastChild=c.jQ.data(d).block=b&&b.blockify()||new h,c.firstChild.parent=c,c.firstChild.jQ=c.jQ.append(c.firstChild.jQ);else{var e,f,g=c.html_template.length;this.firstChild=e=f=b&&b.blockify()||new h,e.parent=c,e.jQ=a(c.html_template[1]).data(d,{block:e}).append(e.jQ).appendTo(c.jQ),e.blur();for(var i=2;i<g;i+=1)e=new h,e.parent=c,e.prev=f,f.next=e,f=e,e.jQ=a(c.html_template[i]).data(d,{block:e}).appendTo(c.jQ),e.blur();c.lastChild=e}},b.latex=function(){return this.foldChildren(this.cmd,function(a,b){return a+"{"+(b.latex()||" ")+"}"})},b.text=function(){var a=0;return this.foldChildren(this.text_template[a],function(b,c){a+=1;var d=c.text();if(b&&this.text_template[a]==="("&&d[0]==="("&&d.slice(-1)===")")return b+d.slice(1,-1)+this.text_template[a];return b+c.text()+(this.text_template[a]||"")})},b.remove=function(){var a=this,b=a.prev,c=a.next,d=a.parent;b?b.next=c:d.firstChild=c,c?c.prev=b:d.lastChild=b,a.jQ.remove();return a},b.respace=a.noop,b.placeCursor=function(a){a.appendTo(this.foldChildren(this.firstChild,function(a,b){return a.isEmpty()?a:b}))},b.isEmpty=function(){return this.foldChildren(!0,function(a,b){return a&&b.isEmpty()})},b=g.prototype=new f,b.initBlocks=a.noop,b.latex=function(){return this.cmd},b.text=function(){return this.text_template},b.placeCursor=a.noop,b.isEmpty=function(){return!0},b=h.prototype=new e,b.latex=function(){return this.foldChildren("",function(a,b){return a+b.latex()})},b.text=function(){return this.firstChild===this.lastChild?this.firstChild.text():this.foldChildren("(",function(a,b){return a+b.text()})+")"},b.isEmpty=function(){return this.firstChild===0&&this.lastChild===0},b.focus=function(){this.jQ.addClass("hasCursor"),this.isEmpty()&&this.jQ.removeClass("empty");return this},b.blur=function(){this.jQ.removeClass("hasCursor"),this.isEmpty()&&this.jQ.addClass("empty");return this},b=i.prototype,b.remove=f.prototype.remove,b.jQinit=function(a){this.jQ=a},b.each=function(a){for(var b=this.prev.next||this.parent.firstChild;b!==this.next;b=b.next)if(a.call(this,b)===!1)break;return this},b.fold=function(a,b){this.each(function(c){a=b.call(this,a,c)});return a},b.latex=function(){return this.fold("",function(a,b){return a+b.latex()})},b.blockify=function(){var a=this,b=a.prev,c=a.next,d=a.parent,e=new h,f=e.firstChild=b.next||d.firstChild,g=e.lastChild=c.prev||d.lastChild;b?b.next=c:d.firstChild=c,c?c.prev=b:d.lastChild=b,f.prev=a.prev=0,g.next=a.next=0,a.parent=e,a.each(function(a){a.parent=e}),e.jQ=a.jQ;return e},b=l.prototype=new h,b.latex=function(){return h.prototype.latex.call(this).replace(/(\\[a-z]+) (?![a-z])/ig,"$1")},b.text=function(){return this.foldChildren("",function(a,b){return a+b.text()})},b.renderLatex=function(a){this.jQ.children().slice(1).remove(),this.firstChild=this.lastChild=0,this.cursor.appendTo(this).writeLatex(a),this.blur()},b.keydown=function(a){this.skipTextInput=!0,a.ctrlKey=a.ctrlKey||a.metaKey;switch(a.originalEvent&&a.originalEvent.keyIdentifier||a.which){case 8:case"Backspace":case"U+0008":if(a.ctrlKey)while(this.cursor.prev||this.cursor.selection)this.cursor.backspace();else this.cursor.backspace();break;case 27:case"Esc":case"U+001B":case 9:case"Tab":case"U+0009":if(a.ctrlKey)break;var b=this.cursor.parent;if(a.shiftKey){if(b===this)break;b.prev?this.cursor.appendTo(b.prev):this.cursor.insertBefore(b.parent)}else{if(b===this)return this.skipTextInput=!0;b.next?this.cursor.prependTo(b.next):this.cursor.insertAfter(b.parent)}this.cursor.clearSelection();return!1;case 13:case"Enter":a.preventDefault();break;case 35:case"End":if(a.shiftKey)while(this.cursor.next||a.ctrlKey&&this.cursor.parent!==this)this.cursor.selectRight();else this.cursor.clearSelection().appendTo(a.ctrlKey?this:this.cursor.parent);a.preventDefault();return!1;case 36:case"Home":if(a.shiftKey)while(this.cursor.prev||a.ctrlKey&&this.cursor.parent!==this)this.cursor.selectLeft();else this.cursor.clearSelection().prependTo(a.ctrlKey?this:this.cursor.parent);a.preventDefault();return!1;case 37:case"Left":if(a.ctrlKey)break;a.shiftKey?this.cursor.selectLeft():this.cursor.moveLeft(),a.preventDefault();return!1;case 38:case"Up":if(a.ctrlKey)break;if(a.shiftKey)if(this.cursor.prev)while(this.cursor.prev)this.cursor.selectLeft();else this.cursor.selectLeft();else this.cursor.parent.prev?this.cursor.clearSelection().appendTo(this.cursor.parent.prev):this.cursor.prev?this.cursor.clearSelection().prependTo(this.cursor.parent):this.cursor.parent!==this&&this.cursor.clearSelection().insertBefore(this.cursor.parent.parent);a.preventDefault();return!1;case 39:case"Right":if(a.ctrlKey)break;a.shiftKey?this.cursor.selectRight():this.cursor.moveRight(),a.preventDefault();return!1;case 40:case"Down":if(a.ctrlKey)break;if(a.shiftKey)if(this.cursor.next)while(this.cursor.next)this.cursor.selectRight();else this.cursor.selectRight();else this.cursor.parent.next?this.cursor.clearSelection().prependTo(this.cursor.parent.next):this.cursor.next?this.cursor.clearSelection().appendTo(this.cursor.parent):this.cursor.parent!==this&&this.cursor.clearSelection().insertAfter(this.cursor.parent.parent);a.preventDefault();return!1;case 46:case"Del":case"U+007F":if(a.ctrlKey)while(this.cursor.next||this.cursor.selection)this.cursor.deleteForward();else this.cursor.deleteForward();break;case 65:case"A":case"U+0041":if(a.ctrlKey&&!a.shiftKey&&!a.altKey){if(this!==this.cursor.root)return this.parent.keydown(a);this.cursor.clearSelection().appendTo(this);while(this.cursor.prev)this.cursor.selectLeft();a.preventDefault();return!1}this.skipTextInput=!1;break;case 67:case"C":case"U+0043":if(a.ctrlKey&&!a.shiftKey&&!a.altKey){if(this!==this.cursor.root)return this.parent.keydown(a);if(!this.cursor.selection)return!0}else this.skipTextInput=!1;break;case 86:case"V":case"U+0056":if(a.ctrlKey&&!a.shiftKey&&!a.altKey){if(this!==this.cursor.root)return this.parent.keydown(a);var c=this;setTimeout(function(){c.cursor.writeLatex(c.cursor.root.textarea.children().val()),c.cursor.clearSelection()})}else this.skipTextInput=!1;break;case 88:case"X":case"U+0058":if(a.ctrlKey&&!a.shiftKey&&!a.altKey){if(this!==this.cursor.root)return this.parent.keydown(a);if(!this.cursor.selection)return!0;this.cursor.deleteSelection()}else this.skipTextInput=!1;break;default:this.skipTextInput=!1}return!0},b.textInput=function(a){this.skipTextInput||this.cursor.write(a)},b=m.prototype=new f,b.html_template=['<span class="mathquill-rendered-math"></span>'],b.initBlocks=function(){this.firstChild=this.lastChild=this.jQ.data(d).block=new l,this.firstChild.parent=this,this.firstChild.jQ=this.jQ},b=n.prototype=new h,b.renderLatex=function(a){var b=this,c=b.cursor;b.jQ.children().slice(1).remove(),b.firstChild=b.lastChild=0,c.show().appendTo(b),a=a.match(/(?:\\\$|[^$])+|\$(?:\\\$|[^$])*\$|\$(?:\\\$|[^$])*$/g)||"";for(var d=0;d<a.length;d+=1){var e=a[d];if(e[0]==="$"){e[-1+e.length]==="$"&&e[-2+e.length]!=="\\"?e=e.slice(1,-1):e=e.slice(1);var f=new m(c);c.insertNew(f),f.firstChild.renderLatex(e),c.show().insertAfter(f)}else for(var g=0;g<e.length;g+=1)this.cursor.insertNew(new J(e[g]))}},b.keydown=l.prototype.keydown,b.textInput=function(a){this.skipTextInput||(this.cursor.deleteSelection(),a==="$"?this.cursor.insertNew(new m(this.cursor)):this.cursor.insertNew(new J(a)))};var o={},p={};b=r.prototype=new f,b.latex=function(){var a=this.firstChild.latex();return a.length===1?this.cmd+a:this.cmd+"{"+(a||" ")+"}"},b.redraw=function(){this.respace(),this.next&&this.next.respace(),this.prev&&this.prev.respace()},b.respace=function(){this.prev.cmd==="\\int "||this.prev instanceof r&&this.prev.cmd!=this.cmd&&this.prev.prev&&this.prev.prev.cmd==="\\int "?this.limit||(this.limit=!0,this.jQ.addClass("limit")):this.limit&&(this.limit=!1,this.jQ.removeClass("limit")),(this.respaced=this.prev instanceof r&&this.prev.cmd!=this.cmd&&!this.prev.respaced)?this.limit&&this.cmd==="_"?this.jQ.css({left:-0.25-this.prev.jQ.outerWidth()/+this.jQ.css("fontSize").slice(0,-2)+"em",marginRight:.1-Math.min(this.jQ.outerWidth(),this.prev.jQ.outerWidth())/+this.jQ.css("fontSize").slice(0,-2)+"em"}):this.jQ.css({left:-this.prev.jQ.outerWidth()/+this.jQ.css("fontSize").slice(0,-2)+"em",marginRight:.1-Math.min(this.jQ.outerWidth(),this.prev.jQ.outerWidth())/+this.jQ.css("fontSize").slice(0,-2)+"em"}):this.limit&&this.cmd==="_"?this.jQ.css({left:"-.25em",marginRight:""}):this.jQ.css({left:"",marginRight:""});return this},p.subscript=p._=q(r,function(a){r.call(this,"_","<sub></sub>","_",a)}),p.superscript=p.supscript=p["^"]=q(r,function(a){r.call(this,"^","<sup></sup>","**",a)}),b=s.prototype=new f,b.html_template=['<span class="fraction"></span>','<span class="numerator"></span>','<span class="denominator"></span>'],b.text_template=["(","/",")"],p.frac=p.fraction=s,b=t.prototype=new s,b.placeCursor=function(a){if(this.firstChild.isEmpty()){var b=this.prev;while(b&&!(b instanceof L||b instanceof B||b instanceof N))b=b.prev;b instanceof N&&b.next instanceof r&&(b=b.next,b.next instanceof r&&b.next.cmd!=b.cmd&&(b=b.next));if(b!==this.prev){var c=(new i(this.parent,b,this)).blockify();c.jQ=this.firstChild.jQ.empty().removeClass("empty").append(c.jQ).data(d,{block:c}),c.next=this.lastChild,c.parent=this,this.firstChild=this.lastChild.prev=c}}a.appendTo(this.lastChild)},o["/"]=t,b=u.prototype=new f,b.html_template=['<span><span class="sqrt-prefix">&radic;</span></span>','<span class="sqrt-stem"></span>'],b.text_template=["sqrt(",")"],b.redraw=function(){var a=this.lastChild.jQ,b=a.outerHeight(!0);a.css({borderTopWidth:b/28+1}).prev().css({fontSize:.9*b/+a.css("fontSize").slice(0,-2)+"em"})},b.optional_arg_command="nthroot",p.sqrt=p["√"]=u,b=v.prototype=new u,b.html_template=['<span><span class="sqrt-prefix">&radic;</span></span>','<sup class="nthroot"></sup>','<span class="sqrt-stem"></span>'],b.text_template=["sqrt[","](",")"],b.latex=function(){return"\\sqrt["+this.firstChild.latex()+"]{"+this.lastChild.latex()+"}"},p.nthroot=v,b=w.prototype=new f,b.initBlocks=function(a){this.firstChild=this.lastChild=a&&a.blockify()||new h,this.firstChild.parent=this,this.firstChild.jQ=this.jQ.children(":eq(1)").data(d,{block:this.firstChild}).append(this.firstChild.jQ)},b.latex=function(){return this.cmd+this.firstChild.latex()+this.end},b.redraw=function(){var a=this.firstChild.jQ;a.prev().add(a.next()).css("fontSize",a.outerHeight()/(+a.css("fontSize").slice(0,-2)*1.02)+"em")},p.lbrace=o["{"]=q(w,function(a){w.call(this,"{","}","\\{","\\}",a)}),p.langle=p.lang=q(w,function(a){w.call(this,"&lang;","&rang;","\\langle ","\\rangle ",a)}),p.lbrack=p.lbracket=o["["]=q(w,function(a){w.call(this,"[","]","\\[","\\]",a)}),b=x.prototype=new w,b.placeCursor=function(a){!this.next&&this.parent.parent&&this.parent.parent.end===this.end&&this.firstChild.isEmpty()?a.backspace().insertAfter(this.parent.parent):this.firstChild.blur()},p.rbrace=o["}"]=q(x,function(a){x.call(this,"{","}","\\{","\\}",a)}),p.rangle=p.rang=q(x,function(a){x.call(this,"&lang;","&rang;","\\langle ","\\rangle ",a)}),p.rbrack=p.rbracket=o["]"]=q(x,function(a){x.call(this,"[","]","\\[","\\]",a)}),y.prototype=w.prototype,p.lparen=o["("]=q(y,function(a){y.call(this,"(",")",a)}),z.prototype=x.prototype,p.rparen=o[")"]=q(z,function(a){z.call(this,"(",")",a)}),b=A.prototype=new y,b.placeCursor=function(a){!this.next&&this.parent.parent&&this.parent.parent.end===this.end&&this.firstChild.isEmpty()?a.backspace().insertAfter(this.parent.parent):a.appendTo(this.firstChild)},p.lpipe=p.rpipe=o["|"]=A,b=B.prototype=new f,b.html_template=['<span class="text"></span>'],b.text_template=['"','"'],b.initBlocks=function(){this.firstChild=this.lastChild=this.jQ.data(d).block=new C,this.firstChild.parent=this,this.firstChild.jQ=this.jQ.append(this.firstChild.jQ)},b.placeCursor=function(a){(this.cursor=a).appendTo(this.firstChild);if(this.replacedText)for(var b=0;b<this.replacedText.length;b+=1)this.write(this.replacedText.charAt(b))},b.write=function(a){this.cursor.insertNew(new J(a))},b.keydown=function(a){if(!this.cursor.selection&&(a.which===8&&!this.cursor.prev||a.which===46&&!this.cursor.next)){this.isEmpty()&&this.cursor.insertAfter(this);return!1}return this.parent.keydown(a)},b.textInput=function(a){this.cursor.deleteSelection();if(a!=="$")this.write(a);else if(this.isEmpty())this.cursor.insertAfter(this).backspace().insertNew(new J("\\$","$"));else if(!this.cursor.next)this.cursor.insertAfter(this);else if(!this.cursor.prev)this.cursor.insertBefore(this);else{var b=new B(new i(this.firstChild,this.cursor.prev));b.placeCursor=function(a){this.prev=0,delete this.placeCursor,this.placeCursor(a)},b.firstChild.focus=function(){return this},this.cursor.insertAfter(this).insertNew(b),b.prev=this,this.cursor.insertBefore(b),delete b.firstChild.focus}},b=C.prototype=new h,b.blur=function(){this.jQ.removeClass("hasCursor");if(this.isEmpty()){var a=this.parent,b=a.cursor;b.parent===this?this.jQ.addClass("empty"):(b.hide(),a.remove(),b.next===a?b.next=a.next:b.prev===a&&(b.prev=a.prev),b.show().redraw())}return this},b.focus=function(){h.prototype.focus.call(this);var a=this.parent;if(a.next instanceof B){var b=this,c=a.cursor,d=a.next.firstChild;d.eachChild(function(a){a.parent=b,a.jQ.appendTo(b.jQ)}),this.lastChild?this.lastChild.next=d.firstChild:this.firstChild=d.firstChild,d.firstChild.prev=this.lastChild,this.lastChild=d.lastChild,d.parent.remove(),c.prev?c.insertAfter(c.prev):c.prependTo(this),c.redraw()}else if(a.prev instanceof B){var c=a.cursor;c.prev?a.prev.firstChild.focus():c.appendTo(a.prev.firstChild)}return this},p.text=o.$=B,b=D.prototype=new f,b.html_template=['<span class="latex-command-input"></span>'],b.text_template=["\\"],b.placeCursor=function(b){this.cursor=b.appendTo(this.firstChild),this.replacedFragment&&(this.jQ=this.jQ.add(this.replacedFragment.jQ.addClass("blur").bind("mousedown mousemove",function(b){a(b.target=this.nextSibling).trigger(b);return!1}).insertBefore(this.jQ)))},b.latex=function(){return"\\"+this.firstChild.latex()+" "},b.keydown=function(a){if(a.which===9||a.which===13){this.renderCommand();return!1}return this.parent.keydown(a)},b.textInput=function(a){if(a.match(/[a-z]/i))this.cursor.deleteSelection(),this.cursor.insertNew(new J(a));else{this.renderCommand();if(a===" "||a==="\\"&&this.firstChild.isEmpty())return;this.cursor.parent.textInput(a)}},b.renderCommand=function(){this.jQ=this.jQ.last(),this.remove(),this.next?this.cursor.insertBefore(this.next):this.cursor.appendTo(this.parent);var a=this.firstChild.latex(),b;if(a)if(b=p[a])b=new b(this.replacedFragment,a);else{b=new B(a),b.firstChild.focus=function(){delete this.focus;return this},this.cursor.insertNew(b).insertAfter(b),this.replacedFragment&&this.replacedFragment.remove();return}else b=new J("\\backslash ","\\");this.cursor.insertNew(b),b instanceof g&&this.replacedFragment&&this.replacedFragment.remove()},o["\\"]=D,b=E.prototype=new f,b.html_template=["<span></span>","<span></span>","<span></span>"],b.text_template=["choose(",",",")"],b.redraw=function(){this.jQ.children(":first").add(this.jQ.children(":last")).css("fontSize",this.jQ.outerHeight()/(+this.jQ.css("fontSize").slice(0,-2)*.9+2)+"em")},p.binom=p.binomial=E,b=F.prototype=new E,b.placeCursor=t.prototype.placeCursor,p.choose=F,b=G.prototype=new f,b.html_template=['<span class="array"></span>',"<span></span>"],b.latex=function(){return"\\begin{matrix}"+this.foldChildren([],function(a,b){a.push(b.latex());return a}).join("\\\\")+"\\end{matrix}"},b.text=function(){return"["+this.foldChildren([],function(a,b){text.push(b.text());return text}).join()+"]"},b.placeCursor=function(a){this.cursor=a.appendTo(this.firstChild)},b.keydown=function(b){var c=this.cursor.parent;if(c.parent===this){if(b.which===13){var e=new h;e.parent=this,e.jQ=a("<span></span>").data(d,{block:e}).insertAfter(c.jQ),c.next?c.next.prev=e:this.lastChild=e,e.next=c.next,c.next=e,e.prev=c,this.cursor.appendTo(e).redraw();return!1}if(b.which===9&&!b.shiftKey&&!c.next){if(c.isEmpty()){if(c.prev){this.cursor.insertAfter(this),delete c.prev.next,this.lastChild=c.prev,c.jQ.remove(),this.cursor.redraw();return!1}return this.parent.keydown(b)}var e=new h;e.parent=this,e.jQ=a("<span></span>").data(d,{block:e}).appendTo(this.jQ),this.lastChild=e,c.next=e,e.prev=c,this.cursor.appendTo(e).redraw();return!1}if(b.which===8){if(c.isEmpty()){c.prev?(this.cursor.appendTo(c.prev),c.prev.next=c.next):(this.cursor.insertBefore(this),this.firstChild=c.next),c.next?c.next.prev=c.prev:this.lastChild=c.prev,c.jQ.remove(),this.isEmpty()?this.cursor.deleteForward():this.cursor.redraw();return!1}if(!this.cursor.prev)return!1}}return this.parent.keydown(b)},p.vector=G,p.editable=q(m,function(){f.call(this,"\\editable"),j(this.jQ,this.firstChild,!1,!0);var a;this.placeCursor=function(b){a=b.appendTo(this.firstChild)},this.firstChild.blur=function(){a.prev===this.parent&&(delete this.blur,this.cursor.appendTo(this),h.prototype.blur.call(this))},this.text=function(){return this.firstChild.text()}}),p.f=H(g,"f",'<var class="florin">&fnof;</var>'),b=I.prototype=new g,b.text=function(){var a=this.cmd;this.prev&&!(this.prev instanceof I)&&!(this.prev instanceof L)&&(a="*"+a),this.next&&!(this.next instanceof L)&&this.next.cmd!=="^"&&(a+="*");return a},J.prototype=g.prototype,o[" "]=H(J,"\\:"," "),p.prime=o["'"]=H(J,"'","&prime;"),K.prototype=g.prototype,p["@"]=K,p["&"]=H(K,"\\&","&"),p["%"]=H(K,"\\%","%"),p.alpha=p.beta=p.gamma=p.delta=p.zeta=p.eta=p.theta=p.iota=p.kappa=p.mu=p.nu=p.xi=p.rho=p.sigma=p.tau=p.chi=p.psi=p.omega=q(g,function(a,b){I.call(this,"\\"+b+" ","&"+b+";")}),p.phi=H(I,"\\phi ","&#981;"),p.phiv=p.varphi=H(I,"\\varphi ","&phi;"),p.epsilon=H(I,"\\epsilon ","&#1013;"),p.epsiv=p.varepsilon=H(I,"\\varepsilon ","&epsilon;"),p.sigmaf=p.sigmav=p.varsigma=H(I,"\\varsigma ","&sigmaf;"),p.upsilon=p.upsi=H(I,"\\upsilon ","&upsilon;"),p.gammad=p.Gammad=p.digamma=H(I,"\\digamma ","&#989;"),p.kappav=p.varkappa=H(I,"\\varkappa ","&#1008;"),p.piv=p.varpi=H(I,"\\varpi ","&#982;"),p.rhov=p.varrho=H(I,"\\varrho ","&#1009;"),p.thetav=p.vartheta=H(I,"\\vartheta ","&#977;"),p.pi=p["π"]=H(K,"\\pi ","&pi;"),p.lambda=H(K,"\\lambda ","&lambda;"),p.Upsilon=p.Upsi=H(I,"\\Upsilon ","&Upsilon;"),p.Gamma=p.Delta=p.Theta=p.Lambda=p.Xi=p.Pi=p.Sigma=p.Phi=p.Psi=p.Omega=p.forall=q(g,function(a,b){J.call(this,"\\"+b+" ","&"+b+";")}),L.prototype=new g,b=M.prototype=new L,b.respace=function(){this.prev?this.prev instanceof L&&this.next&&!(this.next instanceof L)?this.jQ[0].className="unary-operator":this.jQ[0].className="binary-operator":this.jQ[0].className="";return this},p["+"]=H(M,"+"),p["-"]=H(M,"-","&minus;"),p.pm=p.plusmn=p.plusminus=H(M,"\\pm ","&plusmn;"),p.mp=p.mnplus=p.minusplus=H(M,"\\mp ","&#8723;"),o["*"]=p.sdot=p.cdot=H(L,"\\cdot ","&middot;"),p["="]=H(L,"=","="),p["<"]=H(L,"<","&lt;"),p[">"]=H(L,">","&gt;"),p.notin=p.sim=p.cong=p.equiv=p.oplus=p.otimes=q(L,function(a,b){L.call(this,"\\"+b+" ","&"+b+";")}),p.times=q(L,function(a,b){L.call(this,"\\times ","&times;","[x]")}),p.div=p.divide=p.divides=H(L,"\\div ","&divide;","[/]"),p.ne=p.neq=H(L,"\\ne ","&ne;"),p.ast=p.star=p.loast=p.lowast=H(L,"\\ast ","&lowast;"),p.therefor=p.therefore=H(L,"\\therefore ","&there4;"),p.cuz=p.because=H(L,"\\because ","&#8757;"),p.prop=p.propto=H(L,"\\propto ","&prop;"),p.asymp=p.approx=H(L,"\\approx ","&asymp;"),p.lt=H(L,"<","&lt;"),p.gt=H(L,">","&gt;"),p.le=p.leq=H(L,"\\le ","&le;"),p.ge=p.geq=H(L,"\\ge ","&ge;"),p.isin=p["in"]=H(L,"\\in ","&isin;"),p.ni=p.contains=H(L,"\\ni ","&ni;"),p.notni=p.niton=p.notcontains=p.doesnotcontain=H(L,"\\not\\ni ","&#8716;"),p.sub=p.subset=H(L,"\\subset ","&sub;"),p.sup=p.supset=p.superset=H(L,"\\supset ","&sup;"),p.nsub=p.notsub=p.nsubset=p.notsubset=H(L,"\\not\\subset ","&#8836;"),p.nsup=p.notsup=p.nsupset=p.notsupset=p.nsuperset=p.notsuperset=H(L,"\\not\\supset ","&#8837;"),p.sube=p.subeq=p.subsete=p.subseteq=H(L,"\\subseteq ","&sube;"),p.supe=p.supeq=p.supsete=p.supseteq=p.supersete=p.superseteq=H(L,"\\supseteq ","&supe;"),p.nsube=p.nsubeq=p.notsube=p.notsubeq=p.nsubsete=p.nsubseteq=p.notsubsete=p.notsubseteq=H(L,"\\not\\subseteq ","&#8840;"),p.nsupe=p.nsupeq=p.notsupe=p.notsupeq=p.nsupsete=p.nsupseteq=p.notsupsete=p.notsupseteq=p.nsupersete=p.nsuperseteq=p.notsupersete=p.notsuperseteq=H(L,"\\not\\supseteq ","&#8841;"),N.prototype=new g,p.sum=p.summation=H(N,"\\sum ","&sum;"),p.prod=p.product=H(N,"\\prod ","&prod;"),p.coprod=p.coproduct=H(N,"\\coprod ","&#8720;"),p.int=p.integral=p["∫"]=H(N,"\\int ","&int;"),p.N=p.naturals=p.Naturals=H(J,"\\mathbb{N}","&#8469;"),p.P=p.primes=p.Primes=p.projective=p.Projective=p.probability=p.Probability=H(J,"\\mathbb{P}","&#8473;"),p.Z=p.integers=p.Integers=H(J,"\\mathbb{Z}","&#8484;"),p.Q=p.rationals=p.Rationals=H(J,"\\mathbb{Q}","&#8474;"),p.R=p.reals=p.Reals=H(J,"\\mathbb{R}","&#8477;"),p.C=p.complex=p.Complex=p.complexes=p.Complexes=p.complexplane=p.Complexplane=p.ComplexPlane=H(J,"\\mathbb{C}","&#8450;"),p.H=p.Hamiltonian=p.quaternions=p.Quaternions=H(J,"\\mathbb{H}","&#8461;"),p.quad=p.emsp=H(J,"\\quad ","    "),p.qquad=H(J,"\\qquad ","        "),p.diamond=H(J,"\\diamond","&#9671;"),p.bigtriangleup=H(J,"\\bigtriangleup","&#9651;"),p.ominus=H(J,"\\ominus","&#8854;"),p.uplus=H(J,"\\uplus","&#8846;"),p.bigtriangledown=H(J,"\\bigtriangledown","&#9661;"),p.sqcap=H(J,"\\sqcap","&#8851;"),p.triangleleft=H(J,"\\triangleleft","&#8882;"),p.sqcup=H(J,"\\sqcup","&#8852;"),p.triangleright=H(J,"\\triangleright","&#8883;"),p.odot=H(J,"\\odot","&#8857;"),p.bigcirc=H(J,"\\bigcirc","&#9711;"),p.dagger=H(J,"\\dagger","&#0134;"),p.ddagger=H(J,"\\ddagger","&#135;"),p.wr=H(J,"\\wr","&#8768;"),p.amalg=H(J,"\\amalg","&#8720;"),p.models=H(J,"\\models","&#8872;"),p.prec=H(J,"\\prec","&#8826;"),p.succ=H(J,"\\succ","&#8827;"),p.preceq=H(J,"\\preceq","&#8828;"),p.succeq=H(J,"\\succeq","&#8829;"),p.simeq=H(J,"\\simeq","&#8771;"),p.mid=H(J,"\\mid","&#8739;"),p.ll=H(J,"\\ll","&#8810;"),p.gg=H(J,"\\gg","&#8811;"),p.parallel=H(J,"\\parallel","&#8741;"),p.bowtie=H(J,"\\bowtie","&#8904;"),p.sqsubset=H(J,"\\sqsubset","&#8847;"),p.sqsupset=H(J,"\\sqsupset","&#8848;"),p.smile=H(J,"\\smile","&#8995;"),p.sqsubseteq=H(J,"\\sqsubseteq","&#8849;"),p.sqsupseteq=H(J,"\\sqsupseteq","&#8850;"),p.doteq=H(J,"\\doteq","&#8784;"),p.frown=H(J,"\\frown","&#8994;"),p.vdash=H(J,"\\vdash","&#8870;"),p.dashv=H(J,"\\dashv","&#8867;"),p.longleftarrow=H(J,"\\longleftarrow","&#8592;"),p.longrightarrow=H(J,"\\longrightarrow","&#8594;"),p.Longleftarrow=H(J,"\\Longleftarrow","&#8656;"),p.Longrightarrow=H(J,"\\Longrightarrow","&#8658;"),p.longleftrightarrow=H(J,"\\longleftrightarrow","&#8596;"),p.updownarrow=H(J,"\\updownarrow","&#8597;"),p.Longleftrightarrow=H(J,"\\Longleftrightarrow","&#8660;"),p.Updownarrow=H(J,"\\Updownarrow","&#8661;"),p.mapsto=H(J,"\\mapsto","&#8614;"),p.nearrow=H(J,"\\nearrow","&#8599;"),p.hookleftarrow=H(J,"\\hookleftarrow","&#8617;"),p.hookrightarrow=H(J,"\\hookrightarrow"
,"&#8618;"),p.searrow=H(J,"\\searrow","&#8600;"),p.leftharpoonup=H(J,"\\leftharpoonup","&#8636;"),p.rightharpoonup=H(J,"\\rightharpoonup","&#8640;"),p.swarrow=H(J,"\\swarrow","&#8601;"),p.leftharpoondown=H(J,"\\leftharpoondown","&#8637;"),p.rightharpoondown=H(J,"\\rightharpoondown","&#8641;"),p.nwarrow=H(J,"\\nwarrow","&#8598;"),p.ldots=H(J,"\\ldots","&#8230;"),p.cdots=H(J,"\\cdots","&#8943;"),p.vdots=H(J,"\\vdots","&#8942;"),p.ddots=H(J,"\\ddots","&#8944;"),p.surd=H(J,"\\surd","&#8730;"),p.triangle=H(J,"\\triangle","&#9653;"),p.ell=H(J,"\\ell","&#8467;"),p.top=H(J,"\\top","&#8868;"),p.flat=H(J,"\\flat","&#9837;"),p.natural=H(J,"\\natural","&#9838;"),p.sharp=H(J,"\\sharp","&#9839;"),p.wp=H(J,"\\wp","&#8472;"),p.bot=H(J,"\\bot","&#8869;"),p.clubsuit=H(J,"\\clubsuit","&#9827;"),p.diamondsuit=H(J,"\\diamondsuit","&#9826;"),p.heartsuit=H(J,"\\heartsuit","&#9825;"),p.spadesuit=H(J,"\\spadesuit","&#9824;"),p.oint=H(J,"\\oint","&#8750;"),p.bigcap=H(J,"\\bigcap","&#8745;"),p.bigcup=H(J,"\\bigcup","&#8746;"),p.bigsqcup=H(J,"\\bigsqcup","&#8852;"),p.bigvee=H(J,"\\bigvee","&#8744;"),p.bigwedge=H(J,"\\bigwedge","&#8743;"),p.bigodot=H(J,"\\bigodot","&#8857;"),p.bigotimes=H(J,"\\bigotimes","&#8855;"),p.bigoplus=H(J,"\\bigoplus","&#8853;"),p.biguplus=H(J,"\\biguplus","&#8846;"),p.lfloor=H(J,"\\lfloor","&#8970;"),p.rfloor=H(J,"\\rfloor","&#8971;"),p.lceil=H(J,"\\lceil","&#8968;"),p.rceil=H(J,"\\rceil","&#8969;"),p.slash=H(J,"\\slash","&#47;"),p.opencurlybrace=H(J,"\\opencurlybrace","&#123;"),p.closecurlybrace=H(J,"\\closecurlybrace","&#125;"),p.caret=H(J,"\\caret ","^"),p.underscore=H(J,"\\underscore ","_"),p.backslash=H(J,"\\backslash ","\\"),p.vert=H(J,"|"),p.perp=p.perpendicular=H(J,"\\perp ","&perp;"),p.nabla=p.del=H(J,"\\nabla ","&nabla;"),p.hbar=H(J,"\\hbar ","&#8463;"),p.AA=p.Angstrom=p.angstrom=H(J,"\\text\\AA ","&#8491;"),p.ring=p.circ=p.circle=H(J,"\\circ ","&#8728;"),p.bull=p.bullet=H(J,"\\bullet ","&bull;"),p.setminus=p.smallsetminus=H(J,"\\setminus ","&#8726;"),p.not=p.neg=H(J,"\\neg ","&not;"),p.dots=p.ellip=p.hellip=p.ellipsis=p.hellipsis=H(J,"\\dots ","&hellip;"),p.converges=p.darr=p.dnarr=p.dnarrow=p.downarrow=H(J,"\\downarrow ","&darr;"),p.dArr=p.dnArr=p.dnArrow=p.Downarrow=H(J,"\\Downarrow ","&dArr;"),p.diverges=p.uarr=p.uparrow=H(J,"\\uparrow ","&uarr;"),p.uArr=p.Uparrow=H(J,"\\Uparrow ","&uArr;"),p.to=H(L,"\\to ","&rarr;"),p.rarr=p.rightarrow=H(J,"\\rightarrow ","&rarr;"),p.implies=H(L,"\\Rightarrow ","&rArr;"),p.rArr=p.Rightarrow=H(J,"\\Rightarrow ","&rArr;"),p.gets=H(L,"\\gets ","&larr;"),p.larr=p.leftarrow=H(J,"\\leftarrow ","&larr;"),p.impliedby=H(L,"\\Leftarrow ","&lArr;"),p.lArr=p.Leftarrow=H(J,"\\Leftarrow ","&lArr;"),p.harr=p.lrarr=p.leftrightarrow=H(J,"\\leftrightarrow ","&harr;"),p.iff=H(L,"\\Leftrightarrow ","&hArr;"),p.hArr=p.lrArr=p.Leftrightarrow=H(J,"\\Leftrightarrow ","&hArr;"),p.Re=p.Real=p.real=H(J,"\\Re ","&real;"),p.Im=p.imag=p.image=p.imagin=p.imaginary=p.Imaginary=H(J,"\\Im ","&image;"),p.part=p.partial=H(J,"\\partial ","&part;"),p.inf=p.infin=p.infty=p.infinity=H(J,"\\infty ","&infin;"),p.alef=p.alefsym=p.aleph=p.alephsym=H(J,"\\aleph ","&alefsym;"),p.xist=p.xists=p.exist=p.exists=H(J,"\\exists ","&exist;"),p.and=p.land=p.wedge=H(J,"\\wedge ","&and;"),p.or=p.lor=p.vee=H(J,"\\vee ","&or;"),p.o=p.O=p.empty=p.emptyset=p.oslash=p.Oslash=p.nothing=p.varnothing=H(L,"\\varnothing ","&empty;"),p.cup=p.union=H(J,"\\cup ","&cup;"),p.cap=p.intersect=p.intersection=H(J,"\\cap ","&cap;"),p.deg=p.degree=H(J,"^\\circ ","&deg;"),p.ang=p.angle=H(J,"\\angle ","&ang;"),b=O.prototype=new g,b.respace=function(){this.jQ[0].className=this.next instanceof r||this.next instanceof w?"":"non-italicized-function"},p.ln=p.lg=p.log=p.span=p.proj=p.det=p.dim=p.min=p.max=p.mod=p.lcm=p.gcd=p.gcf=p.hcf=p.lim=O,function(){var a=["sin","cos","tan","sec","cosec","csc","cotan","cot"];for(var b in a)p[a[b]]=p[a[b]+"h"]=p["a"+a[b]]=p["arc"+a[b]]=p["a"+a[b]+"h"]=p["arc"+a[b]+"h"]=O}(),b=P.prototype,b.prev=0,b.next=0,b.parent=0,b.show=function(){this.jQ=this._jQ.removeClass("blink"),"intervalId"in this?clearInterval(this.intervalId):(this.next?this.selection&&this.selection.prev===this.prev?this.jQ.insertBefore(this.selection.jQ):this.jQ.insertBefore(this.next.jQ.first()):this.jQ.appendTo(this.parent.jQ),this.parent.focus()),this.intervalId=setInterval(this.blink,500);return this},b.hide=function(){"intervalId"in this&&clearInterval(this.intervalId),delete this.intervalId,this.jQ.detach(),this.jQ=a();return this},b.redraw=function(){for(var a=this.parent;a;a=a.parent)a.redraw&&a.redraw()},b.insertAt=function(a,b,c){var d=this.parent;this.parent=a,this.next=b,this.prev=c,d.blur()},b.insertBefore=function(a){this.insertAt(a.parent,a,a.prev),this.parent.jQ.addClass("hasCursor"),this.jQ.insertBefore(a.jQ.first());return this},b.insertAfter=function(a){this.insertAt(a.parent,a.next,a),this.parent.jQ.addClass("hasCursor"),this.jQ.insertAfter(a.jQ.last());return this},b.prependTo=function(a){this.insertAt(a,a.firstChild,0),a.textarea?this.jQ.insertAfter(a.textarea):this.jQ.prependTo(a.jQ),a.focus();return this},b.appendTo=function(a){this.insertAt(a,0,a.lastChild),this.jQ.appendTo(a.jQ),a.focus();return this},b.hopLeft=function(){this.jQ.insertBefore(this.prev.jQ.first()),this.next=this.prev,this.prev=this.prev.prev;return this},b.hopRight=function(){this.jQ.insertAfter(this.next.jQ.last()),this.prev=this.next,this.next=this.next.next;return this},b.moveLeft=function(){this.selection?this.insertBefore(this.selection.prev.next||this.parent.firstChild).clearSelection():this.prev?this.prev.lastChild?this.appendTo(this.prev.lastChild):this.hopLeft():this.parent.prev?this.appendTo(this.parent.prev):this.parent!==this.root&&this.insertBefore(this.parent.parent);return this.show()},b.moveRight=function(){this.selection?this.insertAfter(this.selection.next.prev||this.parent.lastChild).clearSelection():this.next?this.next.firstChild?this.prependTo(this.next.firstChild):this.hopRight():this.parent.next?this.prependTo(this.parent.next):this.parent!==this.root&&this.insertAfter(this.parent.parent);return this.show()},b.seek=function(a,b,c){var e=this;if(a.hasClass("empty")){e.clearSelection().prependTo(a.data(d).block);return e}var f=a.data(d);if(f){if(f.cmd&&!f.block){e.clearSelection(),a.outerWidth()>2*(b-a.offset().left)?e.insertBefore(f.cmd):e.insertAfter(f.cmd);return e}}else a=a.parent(),f=a.data(d),f||(f={block:e.root});e.clearSelection(),f.cmd?e.insertAfter(f.cmd):e.appendTo(f.block);var g=e.jQ.offset().left-b,h;do e.moveLeft(),h=g,g=e.jQ.offset().left-b;while(g>0&&(e.prev||e.parent!==e.root));-g>h&&e.moveRight();return e},b.resolveNonItalicizedFunctions=function(){var a=this.prev,b=a?a.latex().replace(/ $/,""):null,c=0,d={ln:1,lg:1,log:1,span:1,proj:1,det:1,dim:1,min:1,max:1,mod:1,lcm:1,gcd:1,gcf:1,hcf:1,lim:1,sin:1,sinh:1,asin:1,arcsin:1,asinh:1,arcsinh:1,cos:1,cosh:1,acos:1,arccos:1,acosh:1,arccosh:1,tan:1,tanh:1,atan:1,arctan:1,atanh:1,arctanh:1,sec:1,sech:1,asec:1,arcsec:1,asech:1,arcsech:1,cosec:1,cosech:1,acosec:1,arccosec:1,acosech:1,arccosech:1,csc:1,csch:1,acsc:1,arccsc:1,acsch:1,arccsch:1,cotan:1,cotanh:1,acotan:1,arccotan:1,acotanh:1,arccotanh:1,cot:1,coth:1,acot:1,arccot:1,acoth:1,arccoth:1},e="";while(a&&b){var f=b.match(/^[a-z]$/);if(!(f||e&&b[0]=="\\"&&d[b.substring(1)]&&d[(b+e).substring(1)]))return;c++,e=b.replace(/\\/,"")+e,a=a.prev,b=a?a.latex().replace(/ $/,""):null;if(!f||(!a||!b.match(/^[a-z]$/))&&d[e]){for(var g=0;g<c;g++)this.selectLeft();this.writeLatex("\\"+e);return}}},b.writeLatex=function(b,d){this.deleteSelection(),b=b&&b.match(/\\text\{([^{}]|\\\[{}])*\}|\\[\{\}\[\]]|[\(\)]|\\[a-z]*|[^\s]/ig)||0,function e(f){while(b.length){var g=b.shift();if(!g||g==="}"||g==="]")return;var h;if(g.slice(0,6)==="\\text{"){h=new B(g.slice(6,-1)),f.insertNew(h).insertAfter(h);continue}if(g==="|"){var i=f.prev&&f.prev.prev;while(i&&(i.cmd!="|"||!i.isEmpty()))i=i.prev;if(i){i.remove(),f.selectFrom(i.next),f.show().insertCh(g).insertAfter(f.parent.parent);continue}h=new J(g),f.insertNew(h)}else if(a.inArray(g,["\\lbrace","\\{","\\rbrace","\\}","\\langle","\\lang","\\rangle","\\rang","\\lparen","(","\\rparen",")","\\lbrack","\\lbracket","\\[","\\rbrack","\\rbracket","\\]","\\lpipe","\\rpipe"])>=0){g=g.replace(/^\\/,""),f.insertCh(g),h=f.prev||f.parent.parent;if(f.prev)return;b.unshift("{")}else if(/^\\[a-z]+$/i.test(g)){g=g.slice(1);var h=p[g];if(h)h=new h(c,g),b[0]==="["&&h.optional_arg_command&&(g=h.optional_arg_command,h=new p[g](c,g)),f.insertNew(h);else{h=new B(g),f.insertNew(h).insertAfter(h);continue}}else g.match(/[a-eg-zA-Z]/)?h=new I(g):(h=p[g])?h=new h:h=new J(g),f.insertNew(h);h.eachChild(function(a){f.appendTo(a);var c=b.shift();if(!c)return!1;c==="{"||c==="["?e(f):f.insertCh(c)}),d||f.insertAfter(h)}}(this);return this.hide()},b.write=function(a){var b=this.show().insertCh(a);this.root.toolbar&&this.resolveNonItalicizedFunctions();return b},b.insertCh=function(a){this.selection&&(this.prev=this.selection.prev,this.next=this.selection.next);var b;a.match(/^[a-eg-zA-Z]$/)?b=new I(a):(b=o[a]||p[a])?b=new b(this.selection,a):b=new J(a),this.selection&&(b instanceof g&&this.selection.remove(),delete this.selection);return this.insertNew(b)},b.insertNew=function(a){a.parent=this.parent,a.next=this.next,a.prev=this.prev,this.prev?this.prev.next=a:this.parent.firstChild=a,this.next?this.next.prev=a:this.parent.lastChild=a,a.jQ.insertBefore(this.jQ),a.respace(),this.next&&this.next.respace(),this.prev&&this.prev.respace(),this.prev=a,a.placeCursor(this),this.redraw();return this},b.unwrapGramp=function(){var a=this.parent.parent,b=a.parent,c=a.prev,d=this;a.eachChild(function(d){d.isEmpty()||(d.eachChild(function(c){c.parent=b,c.jQ.insertBefore(a.jQ)}),d.firstChild.prev=c,c?c.next=d.firstChild:b.firstChild=d.firstChild,c=d.lastChild)}),c.next=a.next,a.next?a.next.prev=c:b.lastChild=c;if(!this.next)if(this.prev)this.next=this.prev.next;else while(!this.next){this.parent=this.parent.next;if(this.parent)this.next=this.parent.firstChild;else{this.next=a.next,this.parent=b;break}}this.next?this.insertBefore(this.next):this.appendTo(b),a.jQ.remove(),a.prev&&a.prev.respace(),a.next&&a.next.respace()},b.backspace=function(){if(!this.deleteSelection())if(this.prev)this.prev.isEmpty()?this.prev=this.prev.remove().prev:this.selectLeft();else if(this.parent!==this.root){if(this.parent.parent.isEmpty())return this.insertAfter(this.parent.parent).backspace();this.unwrapGramp()}this.prev&&this.prev.respace(),this.next&&this.next.respace(),this.redraw();return this},b.deleteForward=function(){if(!this.deleteSelection())if(this.next)this.next.isEmpty()?this.next=this.next.remove().next:this.selectRight();else if(this.parent!==this.root){if(this.parent.parent.isEmpty())return this.insertBefore(this.parent.parent).deleteForward();this.unwrapGramp()}this.prev&&this.prev.respace(),this.next&&this.next.respace(),this.redraw();return this},b.selectFrom=function(a){var b=this,c=a;loopThroughAncestors:for(;;){for(var d=this;d!==b.parent.parent;d=d.parent.parent)if(d.parent===c.parent){f=d,g=c;break loopThroughAncestors}for(var e=a;e!==c.parent.parent;e=e.parent.parent)if(b.parent===e.parent){f=b,g=e;break loopThroughAncestors}b.parent.parent&&(b=b.parent.parent),c.parent.parent&&(c=c.parent.parent)}var f,g,h;if(f.next!==g){for(var i=f;i;i=i.next)if(i===g.prev){h=!0;break}h||(h=g,g=f,f=h)}this.hide().selection=new Q(f.parent,f.prev,g.next),this.insertAfter(g.next.prev||g.parent.lastChild),this.selectLatex()},b.selectLeft=function(){this.selection?this.selection.prev===this.prev?this.prev?(this.hopLeft().next.jQ.prependTo(this.selection.jQ),this.selection.prev=this.prev):this.parent!==this.root&&this.insertBefore(this.parent.parent).selection.levelUp():(this.prev.jQ.insertAfter(this.selection.jQ),this.hopLeft().selection.next=this.next,this.selection.prev===this.prev&&this.deleteSelection()):(this.prev?this.hopLeft():this.parent!==this.root&&this.insertBefore(this.parent.parent),this.hide().selection=new Q(this.parent,this.prev,this.next.next)),this.selectLatex()},b.selectRight=function(){this.selection?this.selection.next===this.next?this.next?(this.hopRight().prev.jQ.appendTo(this.selection.jQ),this.selection.next=this.next):this.parent!==this.root&&this.insertAfter(this.parent.parent).selection.levelUp():(this.next.jQ.insertBefore(this.selection.jQ),this.hopRight().selection.prev=this.prev,this.selection.next===this.next&&this.deleteSelection()):(this.next?this.hopRight():this.parent!==this.root&&this.insertAfter(this.parent.parent),this.hide().selection=new Q(this.parent,this.prev.prev,this.next)),this.selectLatex()},b.selectLatex=function(){var a=this.root.textarea.children(),b=this.selection?this.selection.latex():"";a.val(b);if(typeof a[0].selectionStart=="number")a[0].selectionStart=0,a[0].selectionEnd=b.length;else if(document.selection){var c=a[0].createTextRange();c.collapse(!0),c.moveStart("character",0),c.moveEnd("character",b.length),c.select()}},b.clearSelection=function(){this.root.textarea.children().val(""),this.show().selection&&(this.selection.clear(),delete this.selection);return this},b.deleteSelection=function(){if(!this.show().selection)return!1;this.prev=this.selection.prev,this.next=this.selection.next,this.selection.remove(),delete this.selection;return!0},b=Q.prototype=new i,b.jQinit=function(a){this.jQ=a.wrapAll('<span class="selection"></span>').parent()},b.levelUp=function(){this.clear().jQinit(this.parent.parent.jQ),this.prev=this.parent.parent.prev,this.next=this.parent.parent.next,this.parent=this.parent.parent.parent;return this},b.clear=function(){this.jQ.replaceWith(this.jQ.children());return this},b.blockify=function(){this.jQ.replaceWith(this.jQ=this.jQ.children());return i.prototype.blockify.call(this)},b.detach=function(){var a=i.prototype.blockify.call(this);this.blockify=function(){this.jQ.replaceWith(a.jQ=this.jQ=this.jQ.children());return a};return this},a.fn.mathquill=function(b,c){switch(b){case"redraw":this.find(":not(:has(:first))").data(d).cmd.redraw();return this;case"revert":return this.each(function(){var b=a(this).data(d);b&&b.revert&&b.revert()});case"latex":if(arguments.length>1)return this.each(function(){var b=a(this).data(d);b&&b.block&&b.block.renderLatex&&b.block.renderLatex(c)});var e=this.data(d);return e&&e.block&&e.block.latex();case"text":var e=this.data(d);return e&&e.block&&e.block.text();case"html":return this.html().replace(/<span class="?cursor( blink)?"?><\/span>/i,"").replace(/<span class="?textarea"?><textarea><\/textarea><\/span>/i,"");case"write":if(arguments.length>1)return this.each(function(){var b=a(this).data(d),e=b&&b.block,f=e&&e.cursor;f&&(f.writeLatex(c),e.blur())});default:var f=b==="textbox",g=b==="editor",h=g||f||b==="editable",i=f?n:l;return this.each(function(){j(a(this),new i,f,h,g)})}},a(function(){a(".mathquill-editable").mathquill("editable"),a(".mathquill-editor").mathquill("editor"),a(".mathquill-textbox").mathquill("textbox"),a(".mathquill-embedded-latex").mathquill()})})(jQuery)